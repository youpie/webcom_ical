# playbook.yml
---
- name: Create new webcom ical
  hosts: servers
  vars_files:
      - group_vars/all.yml
  vars_prompt:
    - name: personeelsnummer
      prompt: "Voer personeelsnummer in"
      private: no

    - name: wachtwoord
      prompt: "Voer wachtwoord in"
      private: no
      
    - name: mail_to
      prompt: "Waar moet de email naartoe"
      private: no

    - name: hearbeat_url
      prompt: "Enter heartbeat URL (zonder ?*)"
      private: no

    - name: unsecured
      prompt: "Save ical unsecure? (true/false)"
      private: no
      default: "false"
    
    - name: use_email
      prompt: "Use email (true/false)"
      private: no
      default: "true"
      
    - name: new_shift
      prompt: "Mail on new shift (true/false)"
      private: no
      default: "true"

    - name: update_shift
      prompt: "Mail on updated shifts (true/false)"
      private: no
      default: "true"
      
    - name: welcome_mail
      prompt: "Mail on first use (true/false)"
      private: no
      default: "true"

    - name: cron_interval
      prompt: "op welke minuut van het uur moet het programma draaien"
      private: no
      default: "0"

  tasks:
    - name: Create user directory
      ansible.builtin.file:
        path: "~/Services/Webcom/{{ personeelsnummer }}"
        state: directory

    - name: Create .env file from template
      ansible.builtin.template:
        src: templates/env.j2
        dest: "~/Services/Webcom/{{ personeelsnummer }}/.env"

    - name: Create docker-compose.yml from template
      ansible.builtin.template:
        src: templates/docker-compose.yml.j2
        dest: "~/Services/Webcom/{{ personeelsnummer }}/docker-compose.yml"

    - name: Start Docker containers
      community.docker.docker_compose_v2:
        project_src: "~/Services/Webcom/{{ personeelsnummer }}"

    - name: Add cron job to start Docker container every hour
      ansible.builtin.cron:
        name: "Start Docker container for {{ personeelsnummer }}"
        user: "{{remote_username}}"
        minute: "{{59 | random}}"
        hour: "*/1"
        job: "docker start webcom_{{personeelsnummer}}-webcom_ical-1 >/dev/null 2>&1"
      when: remote_username != ""
